<html>

<head>
	<style>
		canvas {
			border: 1px solid black;
/*
            width: 600px;
            height: 600px;
*/
		}
		
		#statusBar {
			height: 20px;
		}
		
		.row {
			clear: left;
		}
		.col {
			float: left;
			margin-right: 10px;
		}
		
		.debugPanel {
			font-family: "Consolas";
			font-size: 10px;
			overflow-y: scroll;
			overflow-x: hidden;
			height: 300px;
			width: 300px;
		}
		
		#entitiesList div {
			margin: 5px 5px;
		}
	</style>
</head>

<body onload="main()">
	<div>
		<div id="statusBar" class="row">
			<div id="cursorCoord" class="col"></div>
<!--
			<div class="col"><button onclick="fwd(16);">fwd</button></div>
			<div class="col"><button onclick="bck(16);">bck</button></div>
-->
		</div>
		<div class="row">
			<canvas id="c" class="col" width="600" height="600"></canvas>
			<div class="col">
				<div id="entitiesList" class="debugPanel"></div>
			</div>
			<div class="col">
				<pre id="debug" class="debugPanel"></pre>
			</div>
		</div>
	</div>


	<script type="text/javascript" src="js/game.js"></script>
	<script type="text/javascript" src="js/v2.js"></script>
	<script type="text/javascript" src="js/particles.js"></script>
	<script type="text/javascript" src="js/shapes.js"></script>
	<script type="text/javascript" src="js/keyboard.js"></script>
	<script type="text/javascript" src="js/mouse.js"></script>
	<script type="text/javascript" src="js/gamepad.js"></script>
	<script type="text/javascript" src="js/spriteAnimator.js"></script>
	<script type="text/javascript" src="js/wrapArray.js"></script>
	<script type="text/javascript" src="js/line2.js"></script>
	<script type="text/javascript" src="js/body.js"></script>
	<script type="text/javascript" src="js/environment.js"></script>
	<script type="text/javascript" src="js/steerMngr.js"></script>
	<script type="text/javascript" src="js/stateMngr.js"></script>
	<script type="text/javascript" src="js/crit.js"></script>
	<script type="text/javascript" src="js/player.js"></script>
	<script type="text/javascript">


// ---------------------------------------
//				M A I N
// ---------------------------------------

var game = new Game();
var prevTime = 0;

function main() {
    game.setCanvas("c");
	game.init();

    gameLoop();
}

function gameLoop(currTime) {
    if (currTime){
        var deltaTime = currTime - prevTime;
        prevTime = currTime;

        game.tick(deltaTime);
    }
    requestAnimationFrame(gameLoop);
};


// ---------------------------------------
//				DEBUG METHODS
// ---------------------------------------

document.getElementById("c").addEventListener("click", function(e) {

});

//var gCanvas = document.getElementById("c");
//var gCtx = gCanvas.getContext("2d");
//var gScreenCenter = [gCanvas.clientWidth / 2, gCanvas.clientHeight / 2];
//var gCircle = {
//    center: [
//        getRandi(100, gCanvas.clientWidth  - 100),
//        getRandi(100, gCanvas.clientHeight - 100)
//        ],
//    radius: getRandi(50, 100)
//}
//document.getElementById("c").addEventListener("mousemove", function(e) {
//    gCtx.clearRect(0, 0, gCanvas.clientWidth, gCanvas.clientHeight);
//
//
//    var line = {A: gScreenCenter, B: [e.offsetX, e.offsetY]};
////    _debug.drawLine(gCtx, line, "black");
//    _debug.drawCircle(gCtx, gCircle, "red");
//
//    var cPoint = v2.closestPointOnSegment(gCircle.center, line);
//    var intersections = v2.segmentCircleIntersetion(line, gCircle);
//    var AB = v2.subv(line.B, line.A);
//    _debug.addMsg("result", intersections.join(","));
//    intersections.forEach(function (p) {
//        v2.draw(gCtx, v2.muls(AB, p), line.A, "black");
//        _debug.drawPoint(gCtx, p, "red");
//    });
//
//    _debug.drawPoint(gCtx, cPoint, "green");
//    _debug.print();
//});


// dumps all entities in environment to given html element as text;
function listEntities(id) {
	var htmlEl = document.getElementById(id);
	htmlEl.innerHTML = "";
	_env.entities.forEach(function(ent){
		var t = "<div>";
		t += ent.name;
		t += " {" + ent.type + "}";
		if (ent.type == "crit") {
			t += " [" + ent.health + "]";
		}
		t += "</div>";
		htmlEl.innerHTML += t;
	});
}

setInterval(function(){
//	if (_env){
//		listEntities("entitiesList");
//	}
	
}, 250);









// ---------------------------------------
//				U T I L S
// ---------------------------------------

function getRand() {
  return Math.random();
}

function getRandi(min, max) {
  return Math.floor(getRand() * (max - min)) + min;
}

function getRandf(min, max) {
  return getRand() * (max - min) + min;
}

function degToRad(degrees) {
	return degrees * Math.PI / 180;
}

var _ctx = document.getElementById("c").getContext("2d");
// get html element which serves as area where all the debug text is getting dumped periodically  
var _debug = function() {}
_debug._on = true;
_debug.dMsg = [];
_debug.text = "";
_debug.w = document.getElementById("debug");
_debug.clear = function() {
	this.dMsg = [];
    this.w.innerHTML = "";
};
_debug.addMsg = function() {
//    console.log(arguments);
	if (this._on) {
        var id = arguments[0];
        var text = "";
		for (var i=1; i<arguments.length; i++){
			text += arguments[i] + ",";
		}


        var msg;
		for (var i=0; i<this.dMsg.length; i++){
            if (this.dMsg[i].id === id)
                msg = this.dMsg[i];
        }

        if (msg) {
            msg.text = text;
            msg.ts = new Date();
        }
        else {
            this.dMsg.push({id: id, ts: new Date(), text: text});
            this.dMsg.sort(function(a,b){return a.ts.getTime() - b.ts.getTime();});
        }

	}
};
_debug.print = function() {
    var t = "";
    for (var i=0; i<this.dMsg.length; i++){
//        t += "[" + this.dMsg[i].ts.toLocaleTimeString() + "] ";
	    t += this.dMsg[i].id + ": " + this.dMsg[i].text + "\n";
    }

    this.w.innerHTML = t;
    this.w.innerHTML += this.text;
}
_debug.drawLine = function(ctx, line, color) {
	if (this._on) {
		var c = color || "black";
		ctx.strokeStyle = c;
		ctx.beginPath();
		ctx.moveTo(line.A[0], line.A[1]);
		ctx.lineTo(line.B[0], line.B[1]);
		ctx.stroke();
	}
};
_debug.drawPoint = function(ctx, point, color) {
	if (this._on) {
		var c = color || "black";
		ctx.strokeStyle = c;
		ctx.beginPath();
		ctx.moveTo(point[0] - 3, point[1] - 3);
		ctx.lineTo(point[0] + 3, point[1] + 3);
        ctx.moveTo(point[0] + 3, point[1] - 3);
		ctx.lineTo(point[0] - 3, point[1] + 3);
		ctx.stroke();
	}
};
_debug.drawCircle = function(ctx, circle, color) {
    "use strict";
	if (this._on) {
        var c = color || "black";
        ctx.strokeStyle = c;
        ctx.beginPath();
        ctx.arc(circle.center[0], circle.center[1], circle.radius, 0, 2 * Math.PI);
        ctx.stroke();

        _debug.drawPoint(ctx, circle.center, c);
	}
};
	</script>
</body>

</html>
